{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Editar Perfil - DeRevés{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Editar Perfil</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <h6 class="border-bottom pb-2 mb-3">Información de Cuenta</h6>
                        
                        <div class="mb-4 text-center">
                            <label class="form-label d-block">Foto de Perfil</label>
                            <div class="mb-3">
                                {% if user.foto_perfil %}
                                    <img src="{{ user.foto_perfil.url }}" alt="Foto de perfil actual" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                                        <span class="material-symbols-rounded text-white" style="font-size: 60px;">person</span>
                                    </div>
                                {% endif %}
                            </div>
                            <input type="file" class="form-control" id="foto_perfil" name="foto_perfil" accept="image/*">
                            <small class="text-muted">JPG, PNG o GIF. Máximo 5MB.</small>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="username" class="form-label">Nombre de Usuario *</label>
                                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nombre_real" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre_real" name="nombre_real" value="{{ user.nombre_real|default:'' }}" placeholder="Tu nombre real">
                        </div>
                        
                        {% if user.tipo_usuario == 'JUGADOR' and perfil %}
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Información de Jugador</h6>
                        <div class="mb-3">
                            <label for="deportes" class="form-label">Deportes que practicas</label>
                            <select class="form-select" id="deportes" name="deportes" multiple required>
                                {% for deporte in deportes_disponibles %}
                                    <option value="{{ deporte.id }}" {% if deporte.id in deportes_seleccionados %}selected{% endif %}>{{ deporte.nombre }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Puedes seleccionar más de uno (Ctrl/Cmd + click)</small>
                        </div>
                        <div id="deportes-campos">
                            {% for jd in jugador_deportes %}
                                <div class="deporte-campos mb-3" data-deporte-id="{{ jd.deporte.id }}">
                                    <div class="card card-body border-primary mb-2">
                                        <h6 class="mb-2">{{ jd.deporte.nombre }}</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Categoría/Nivel</label>
                                                {% with categorias=categorias_por_deporte|get_item:jd.deporte.id %}
                                                <select class="form-select" name="categoria_{{ jd.deporte.id }}">
                                                    <option value="">Seleccionar...</option>
                                                    {% for cat in categorias %}
                                                        <option value="{{ cat.nombre }}" {% if jd.categoria == cat.nombre %}selected{% endif %}>{{ cat.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% endwith %}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Habilidad/Posición</label>
                                                {% with habilidades=habilidades_por_deporte|get_item:jd.deporte.id %}
                                                <select class="form-select" name="posicion_{{ jd.deporte.id }}">
                                                    <option value="">Seleccionar...</option>
                                                    {% for hab in habilidades %}
                                                        <option value="{{ hab.nombre }}" {% if jd.posicion_favorita == hab.nombre %}selected{% endif %}>{{ hab.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% endwith %}
                                            {% comment %} Filtro para acceder a diccionario por clave en Django template {% endcomment %}
                                            {% if not get_item %}
                                                {% load custom_filters %}
                                            {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Lado hábil</label>
                                                <select class="form-select" name="lado_{{ jd.deporte.id }}">
                                                    <option value="">Seleccionar...</option>
                                                    <option value="DERECHO" {% if jd.lado_habil == 'DERECHO' %}selected{% endif %}>Derecho</option>
                                                    <option value="IZQUIERDO" {% if jd.lado_habil == 'IZQUIERDO' %}selected{% endif %}>Izquierdo</option>
                                                    <option value="AMBOS" {% if jd.lado_habil == 'AMBOS' %}selected{% endif %}>Ambos</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- Template oculto para nuevos deportes -->
                        <template id="template-deporte-campos">
                            <div class="deporte-campos mb-3" data-deporte-id="__ID__" style="display:none;">
                                <div class="card card-body border-primary mb-2">
                                    <h6 class="mb-2">__NOMBRE__</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Categoría/Nivel</label>
                                            <select class="form-select" name="categoria___ID__">__CATEGORIAS__</select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Habilidad/Posición</label>
                                            <select class="form-select" name="posicion___ID__">__HABILIDADES__</select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Lado hábil</label>
                                            <select class="form-select" name="lado___ID__">
                                                <option value="">Seleccionar...</option>
                                                <option value="DERECHO">Derecho</option>
                                                <option value="IZQUIERDO">Izquierdo</option>
                                                <option value="AMBOS">Ambos</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        {% json_script habilidades_por_deporte "habilidades-json" %}
                        {% json_script categorias_por_deporte "categorias-json" %}
                        <script>
                        // Mostrar/ocultar/agregar campos de cada deporte según selección
                        document.addEventListener('DOMContentLoaded', function() {
                            const selectDeportes = document.getElementById('deportes');
                            const contenedorCampos = document.getElementById('deportes-campos');
                            const template = document.getElementById('template-deporte-campos');
                            // Map para saber qué deportes ya tienen bloque
                            let deportesActivos = Array.from(document.querySelectorAll('.deporte-campos')).map(div => div.getAttribute('data-deporte-id'));
                            // Obtener datos JSON de habilidades y categorías
                            const habilidadesPorDeporte = JSON.parse(document.getElementById('habilidades-json').textContent);
                            const categoriasPorDeporte = JSON.parse(document.getElementById('categorias-json').textContent);
                            function crearOpciones(arr, selected) {
                                let html = '<option value="">Seleccionar...</option>';
                                arr.forEach(obj => {
                                    html += `<option value="${obj.nombre}"${selected===obj.nombre?' selected':''}>${obj.nombre}</option>`;
                                });
                                return html;
                            }
                            function agregarBloqueDeporte(id, nombre) {
                                if (document.querySelector('.deporte-campos[data-deporte-id="'+id+'"]')) return;
                                const clone = template.content.cloneNode(true);
                                let html = clone.firstElementChild.outerHTML;
                                // Rellenar selects
                                const cats = categoriasPorDeporte[id] || [];
                                const habs = habilidadesPorDeporte[id] || [];
                                html = html.replace(/__ID__/g, id)
                                           .replace(/__NOMBRE__/g, nombre)
                                           .replace('__CATEGORIAS__', crearOpciones(cats))
                                           .replace('__HABILIDADES__', crearOpciones(habs));
                                // Insertar
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = html;
                                contenedorCampos.appendChild(tempDiv.firstElementChild);
                            }
                            function quitarBloqueDeporte(id) {
                                const div = document.querySelector('.deporte-campos[data-deporte-id="'+id+'"]');
                                if (div) div.remove();
                            }
                            function actualizarCampos() {
                                const seleccionados = Array.from(selectDeportes.selectedOptions).map(opt => opt.value);
                                // Agregar los nuevos
                                seleccionados.forEach(id => {
                                    if (!document.querySelector('.deporte-campos[data-deporte-id="'+id+'"]')) {
                                        const nombre = selectDeportes.querySelector('option[value="'+id+'"]')?.textContent || '';
                                        agregarBloqueDeporte(id, nombre);
                                    }
                                    document.querySelector('.deporte-campos[data-deporte-id="'+id+'"]').style.display = '';
                                });
                                // Quitar los no seleccionados
                                document.querySelectorAll('.deporte-campos').forEach(div => {
                                    if (!seleccionados.includes(div.getAttribute('data-deporte-id'))) {
                                        div.remove();
                                    }
                                });
                            }
                            selectDeportes.addEventListener('change', actualizarCampos);
                            // Inicial
                            actualizarCampos();
                        });
                        </script>
                        
                        <div class="mb-3">
                            <label for="biografia" class="form-label">Biografía</label>
                            <textarea class="form-control" id="biografia" name="biografia" rows="4" placeholder="Cuéntanos sobre ti...">{{ perfil.biografia|default:'' }}</textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="localidad" class="form-label">Localidad</label>
                                <input type="text" class="form-control" id="localidad" name="localidad" value="{{ perfil.localidad|default:'' }}" placeholder="Tu ciudad">
                            </div>
                            <div class="col-md-6">
                                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ perfil.fecha_nacimiento|date:'Y-m-d'|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="perfil_publico" name="perfil_publico" {% if perfil.perfil_publico %}checked{% endif %}>
                            <label class="form-check-label" for="perfil_publico">
                                Hacer mi perfil público
                            </label>
                        </div>
                        
                        {% elif user.tipo_usuario == 'DUENIO' and perfil %}
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Información del Negocio</h6>
                        
                        <div class="mb-3">
                            <label for="nombre_negocio" class="form-label">Nombre del Negocio</label>
                            <input type="text" class="form-control" id="nombre_negocio" name="nombre_negocio" value="{{ perfil.nombre_negocio|default:'' }}" placeholder="Nombre de tu complejo o empresa">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="telefono_contacto" class="form-label">Teléfono de Contacto</label>
                                <input type="tel" class="form-control" id="telefono_contacto" name="telefono_contacto" value="{{ perfil.telefono_contacto|default:'' }}" placeholder="+54 9 11 1234-5678">
                            </div>
                            <div class="col-md-6">
                                <label for="cuit_cuil" class="form-label">CUIT/CUIL</label>
                                <input type="text" class="form-control" id="cuit_cuil" name="cuit_cuil" value="{{ perfil.cuit_cuil|default:'' }}" placeholder="XX-XXXXXXXX-X">
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'cuentas:mi_perfil' %}" class="btn btn-outline-secondary">
                                <span class="material-symbols-rounded">cancel</span>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <span class="material-symbols-rounded">save</span>
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">Zona de Peligro</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor, asegúrate.</p>
                    <button class="btn btn-outline-danger" disabled>
                        <span class="material-symbols-rounded">delete_forever</span>
                        Eliminar Cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
