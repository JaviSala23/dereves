{% extends 'base.html' %}

{% block title %}Crear Complejo - DeRevés{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title mb-4">Crear Nuevo Complejo</h2>
                    
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre del Complejo *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" placeholder="Describe tu complejo..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="pais" class="form-label">País *</label>
                                <select class="form-select" id="pais" name="pais" required>
                                    <option value="Argentina" selected>Argentina</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="provincia" class="form-label">Provincia *</label>
                                <select class="form-select" id="provincia" name="provincia" required>
                                    <option value="">Selecciona una provincia</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="localidad" class="form-label">Localidad *</label>
                                <div class="input-group">
                                    <select class="form-select" id="localidad" name="localidad" required>
                                        <option value="">Primero selecciona provincia</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="btnAgregarLocalidad" title="Agregar nueva localidad">
                                        <span class="material-symbols-rounded">add</span>
                                    </button>
                                </div>
                                <small class="text-muted">¿No está tu localidad? Agrégala con el botón +</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="direccion" class="form-label">Dirección *</label>
                                <input type="text" class="form-control" id="direccion" name="direccion" required placeholder="Ej: Av. Libertador 1234">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="latitud" name="latitud" required placeholder="-30.5" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="longitud" name="longitud" required placeholder="-61.5" readonly>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ubicación en el Mapa *</label>
                            <p class="text-muted small mb-2">Haz clic en el mapa para seleccionar la ubicación exacta de tu complejo</p>
                            <div id="map" style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 8px;"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="3537-123456">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="info@complejo.com">
                            </div>
                        </div>
                        
                        <!-- Sección de Foto/Portada -->
                        <hr class="my-4">
                        <h4 class="mb-3">Foto de Portada</h4>
                        
                        <div class="mb-3">
                            <label for="logo" class="form-label">Foto de Portada *</label>
                            <input type="file" class="form-control" id="logo" name="logo" accept="image/*" required>
                            <small class="text-muted">Foto principal que aparecerá en las listas. Recomendado: 1200x600px</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <span class="material-symbols-rounded">info</span>
                            Los campos marcados con * son obligatorios
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span class="material-symbols-rounded">add</span>
                                Crear Complejo
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const provinciaSelect = document.getElementById('provincia');
    const localidadSelect = document.getElementById('localidad');
    const btnAgregarLocalidad = document.getElementById('btnAgregarLocalidad');
    
    // Cargar provincias al inicio
    fetch('{% url "complejos:api_provincias" %}')
        .then(response => response.json())
        .then(data => {
            data.provincias.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                provinciaSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error cargando provincias:', error);
        });
    
    // Función para cargar localidades
    function cargarLocalidades(provincia) {
        localidadSelect.innerHTML = '<option value="">Cargando localidades...</option>';
        localidadSelect.disabled = true;
        
        if (!provincia) {
            localidadSelect.innerHTML = '<option value="">Primero selecciona provincia</option>';
            return;
        }
        
        fetch(`{% url "complejos:api_localidades" %}?provincia=${encodeURIComponent(provincia)}`)
            .then(response => response.json())
            .then(data => {
                localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';
                
                if (data.localidades.length === 0) {
                    localidadSelect.innerHTML = '<option value="">No hay localidades disponibles</option>';
                } else {
                    data.localidades.forEach(localidad => {
                        const option = document.createElement('option');
                        option.value = localidad;
                        option.textContent = localidad;
                        localidadSelect.appendChild(option);
                    });
                    localidadSelect.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error cargando localidades:', error);
                localidadSelect.innerHTML = '<option value="">Error cargando localidades</option>';
            });
    }
    
    // Cuando cambia la provincia, cargar localidades
    provinciaSelect.addEventListener('change', function() {
        cargarLocalidades(this.value);
    });
    
    // Agregar nueva localidad
    btnAgregarLocalidad.addEventListener('click', async function() {
        const provincia = provinciaSelect.value;
        
        if (!provincia) {
            Swal.fire({
                icon: 'warning',
                title: 'Provincia requerida',
                text: 'Por favor, primero selecciona una provincia',
                confirmButtonText: 'Entendido'
            });
            return;
        }
        
        // Mostrar input con SweetAlert2
        const { value: nombreLocalidad } = await Swal.fire({
            title: 'Agregar Localidad',
            text: `Ingresa el nombre de la localidad en ${provincia}:`,
            input: 'text',
            inputPlaceholder: 'Ej: Villa María',
            showCancelButton: true,
            confirmButtonText: 'Agregar',
            cancelButtonText: 'Cancelar',
            inputValidator: (value) => {
                if (!value || value.trim() === '') {
                    return 'Debes ingresar un nombre';
                }
            }
        });
        
        if (!nombreLocalidad) {
            return;
        }
        
        // Mostrar indicador de carga
        btnAgregarLocalidad.disabled = true;
        btnAgregarLocalidad.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        // Enviar solicitud para agregar localidad
        fetch('{% url "complejos:api_agregar_localidad" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                nombre: nombreLocalidad.trim(),
                provincia: provincia,
                pais: 'Argentina'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: data.mensaje,
                    timer: 2000,
                    showConfirmButton: false
                });
                // Recargar la lista de localidades
                cargarLocalidades(provincia);
                // Seleccionar la nueva localidad
                setTimeout(() => {
                    localidadSelect.value = data.localidad.nombre;
                }, 500);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'No se pudo agregar la localidad',
                    confirmButtonText: 'Entendido'
                });
            }
        })
        .catch(error => {
            console.error('Error agregando localidad:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo agregar la localidad. Intenta nuevamente.',
                confirmButtonText: 'Entendido'
            });
        })
        .finally(() => {
            // Restaurar botón
            btnAgregarLocalidad.disabled = false;
            btnAgregarLocalidad.innerHTML = '<span class="material-symbols-rounded">add</span>';
        });
    });
});
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
let map;
let marker;

function initMap() {
    // Ubicación inicial (Centro de Argentina)
    const defaultLocation = { lat: -31.4201, lng: -64.1888 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: defaultLocation,
        mapTypeControl: true,
        streetViewControl: false
    });
    
    // Crear marcador inicial (oculto)
    marker = new google.maps.Marker({
        map: map,
        draggable: true,
        visible: false
    });
    
    // Evento al hacer clic en el mapa
    map.addListener('click', function(event) {
        placeMarker(event.latLng);
    });
    
    // Evento al arrastrar el marcador
    marker.addListener('dragend', function(event) {
        updateCoordinates(event.latLng);
    });
    
    // Geocoding cuando se complete la dirección
    const direccionInput = document.getElementById('direccion');
    const localidadSelect = document.getElementById('localidad');
    const provinciaSelect = document.getElementById('provincia');
    
    direccionInput.addEventListener('blur', function() {
        geocodeAddress();
    });
    
    localidadSelect.addEventListener('change', function() {
        geocodeAddress();
    });
    
    provinciaSelect.addEventListener('change', function() {
        geocodeAddress();
    });
}

function placeMarker(location) {
    marker.setPosition(location);
    marker.setVisible(true);
    updateCoordinates(location);
}

function updateCoordinates(location) {
    document.getElementById('latitud').value = location.lat().toFixed(6);
    document.getElementById('longitud').value = location.lng().toFixed(6);
}

function geocodeAddress() {
    const direccion = document.getElementById('direccion').value;
    const localidad = document.getElementById('localidad').options[document.getElementById('localidad').selectedIndex]?.text || '';
    const provincia = document.getElementById('provincia').value || '';
    
    // Si no hay provincia, no hacer nada
    if (!provincia) return;
    
    // Construir dirección según lo que tengamos
    let fullAddress = '';
    if (direccion && localidad) {
        fullAddress = `${direccion}, ${localidad}, ${provincia}, Argentina`;
    } else if (localidad) {
        fullAddress = `${localidad}, ${provincia}, Argentina`;
    } else {
        fullAddress = `${provincia}, Argentina`;
    }
    
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: fullAddress }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const location = results[0].geometry.location;
            map.setCenter(location);
            
            // Ajustar zoom según el nivel de detalle
            if (direccion && localidad) {
                map.setZoom(16); // Dirección específica
                placeMarker(location);
            } else if (localidad) {
                map.setZoom(13); // Localidad
                placeMarker(location);
            } else {
                map.setZoom(8); // Provincia
                // No colocar marcador aún, solo centrar
            }
        }
    });
}

// Inicializar el mapa cuando cargue la página
window.addEventListener('load', function() {
    initMap();
});
</script>
{% endblock %}
