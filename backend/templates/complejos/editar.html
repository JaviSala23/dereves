{% extends 'base.html' %}

{% block title %}Editar Complejo - {{ complejo.nombre }} - DeRevés{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="card-title mb-0">Editar Complejo</h2>
                        <a href="{% url 'complejos:detalle' complejo.slug %}" class="btn btn-outline-secondary">
                            <span class="material-symbols-rounded">arrow_back</span>
                            Volver
                        </a>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" id="formEditarComplejo">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre del Complejo *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" value="{{ complejo.nombre }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" placeholder="Describe tu complejo...">{{ complejo.descripcion }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="pais" class="form-label">País *</label>
                                <select class="form-select" id="pais" name="pais" required>
                                    <option value="Argentina" {% if complejo.pais == 'Argentina' %}selected{% endif %}>Argentina</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="provincia" class="form-label">Provincia *</label>
                                <select class="form-select" id="provincia" name="provincia" required>
                                    <option value="">Cargando...</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="localidad" class="form-label">Localidad *</label>
                                <div class="input-group">
                                    <select class="form-select" id="localidad" name="localidad" required>
                                        <option value="">Selecciona provincia primero</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="btnAgregarLocalidad" title="Agregar nueva localidad">
                                        <span class="material-symbols-rounded">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="direccion" class="form-label">Dirección *</label>
                                <input type="text" class="form-control" id="direccion" name="direccion" value="{{ complejo.direccion }}" required placeholder="Ej: Av. Libertador 1234">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="latitud" name="latitud" value="{{ complejo.latitud }}" required placeholder="-30.5">
                                <small class="text-muted">Usa Google Maps para obtener coordenadas</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="longitud" name="longitud" value="{{ complejo.longitud }}" required placeholder="-61.5">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" value="{{ complejo.telefono }}" placeholder="3537-123456">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ complejo.email }}" placeholder="info@complejo.com">
                            </div>
                        </div>
                        
                        <!-- Sección de Fotos -->
                        <hr class="my-4">
                        <h4 class="mb-3">Fotos del Complejo</h4>
                        
                        <!-- Logo/Foto Principal -->
                        <div class="mb-4">
                            <label for="logo" class="form-label">Logo o Foto Principal</label>
                            {% if complejo.logo %}
                            <div class="mb-2">
                                <img src="{{ complejo.logo.url }}" alt="Logo actual" class="img-thumbnail" style="max-height: 150px;">
                                <p class="text-muted small mt-1">Logo actual</p>
                            </div>
                            {% endif %}
                            <input type="file" class="form-control" id="logo" name="logo" accept="image/*">
                            <small class="text-muted">Foto principal que aparecerá en las listas</small>
                        </div>
                        
                        <!-- Galería de Fotos -->
                        <div class="mb-4">
                            <label class="form-label">Galería de Fotos (múltiples)</label>
                            
                            {% if complejo.fotos.all %}
                            <div class="row g-2 mb-3" id="fotosActuales">
                                {% for foto in complejo.fotos.all %}
                                <div class="col-md-3" data-foto-id="{{ foto.id }}">
                                    <div class="card">
                                        <img src="{{ foto.imagen.url }}" class="card-img-top" alt="Foto">
                                        <div class="card-body p-2">
                                            <button type="button" class="btn btn-sm btn-danger w-100 btn-eliminar-foto" data-foto-id="{{ foto.id }}">
                                                <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <input type="file" class="form-control" id="fotos" name="fotos" accept="image/*" multiple>
                            <small class="text-muted">Puedes seleccionar múltiples fotos. Formatos: JPG, PNG. Máximo 5MB por foto.</small>
                            
                            <!-- Preview de fotos nuevas -->
                            <div id="previewFotos" class="row g-2 mt-2"></div>
                        </div>
                        
                        <div class="alert alert-info">
                            <span class="material-symbols-rounded">info</span>
                            Los campos marcados con * son obligatorios
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span class="material-symbols-rounded">save</span>
                                Guardar Cambios
                            </button>
                            <a href="{% url 'complejos:detalle' complejo.slug %}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const provinciaSelect = document.getElementById('provincia');
    const localidadSelect = document.getElementById('localidad');
    const btnAgregarLocalidad = document.getElementById('btnAgregarLocalidad');
    const fotosInput = document.getElementById('fotos');
    const previewFotos = document.getElementById('previewFotos');
    
    const provinciaActual = '{{ complejo.provincia }}';
    const localidadActual = '{{ complejo.localidad }}';
    
    // Cargar provincias al inicio
    fetch('{% url "complejos:api_provincias" %}')
        .then(response => response.json())
        .then(data => {
            provinciaSelect.innerHTML = '<option value="">Selecciona una provincia</option>';
            data.provincias.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                if (provincia === provinciaActual) {
                    option.selected = true;
                }
                provinciaSelect.appendChild(option);
            });
            
            // Cargar localidades de la provincia actual
            if (provinciaActual) {
                cargarLocalidades(provinciaActual, localidadActual);
            }
        })
        .catch(error => {
            console.error('Error cargando provincias:', error);
        });
    
    // Función para cargar localidades
    function cargarLocalidades(provincia, seleccionar = null) {
        localidadSelect.innerHTML = '<option value="">Cargando localidades...</option>';
        localidadSelect.disabled = true;
        
        if (!provincia) {
            localidadSelect.innerHTML = '<option value="">Primero selecciona provincia</option>';
            return;
        }
        
        fetch(`{% url "complejos:api_localidades" %}?provincia=${encodeURIComponent(provincia)}`)
            .then(response => response.json())
            .then(data => {
                localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';
                
                if (data.localidades.length === 0) {
                    localidadSelect.innerHTML = '<option value="">No hay localidades disponibles</option>';
                } else {
                    data.localidades.forEach(localidad => {
                        const option = document.createElement('option');
                        option.value = localidad;
                        option.textContent = localidad;
                        if (seleccionar && localidad === seleccionar) {
                            option.selected = true;
                        }
                        localidadSelect.appendChild(option);
                    });
                    localidadSelect.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error cargando localidades:', error);
                localidadSelect.innerHTML = '<option value="">Error cargando localidades</option>';
            });
    }
    
    // Cuando cambia la provincia, cargar localidades
    provinciaSelect.addEventListener('change', function() {
        cargarLocalidades(this.value);
    });
    
    // Agregar nueva localidad
    btnAgregarLocalidad.addEventListener('click', async function() {
        const provincia = provinciaSelect.value;
        
        if (!provincia) {
            Swal.fire({
                icon: 'warning',
                title: 'Provincia requerida',
                text: 'Por favor, primero selecciona una provincia',
                confirmButtonText: 'Entendido'
            });
            return;
        }
        
        const { value: nombreLocalidad } = await Swal.fire({
            title: 'Agregar Localidad',
            text: `Ingresa el nombre de la localidad en ${provincia}:`,
            input: 'text',
            inputPlaceholder: 'Ej: Villa María',
            showCancelButton: true,
            confirmButtonText: 'Agregar',
            cancelButtonText: 'Cancelar',
            inputValidator: (value) => {
                if (!value || value.trim() === '') {
                    return 'Debes ingresar un nombre';
                }
            }
        });
        
        if (!nombreLocalidad) return;
        
        btnAgregarLocalidad.disabled = true;
        btnAgregarLocalidad.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        fetch('{% url "complejos:api_agregar_localidad" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                nombre: nombreLocalidad.trim(),
                provincia: provincia,
                pais: 'Argentina'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: data.mensaje,
                    timer: 2000,
                    showConfirmButton: false
                });
                cargarLocalidades(provincia, data.localidad.nombre);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'No se pudo agregar la localidad',
                    confirmButtonText: 'Entendido'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo agregar la localidad. Intenta nuevamente.',
                confirmButtonText: 'Entendido'
            });
        })
        .finally(() => {
            btnAgregarLocalidad.disabled = false;
            btnAgregarLocalidad.innerHTML = '<span class="material-symbols-rounded">add</span>';
        });
    });
    
    // Preview de fotos nuevas
    fotosInput.addEventListener('change', function(e) {
        previewFotos.innerHTML = '';
        const files = Array.from(e.target.files);
        
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-3';
                col.innerHTML = `
                    <div class="card">
                        <img src="${e.target.result}" class="card-img-top" alt="Preview">
                        <div class="card-body p-2">
                            <small class="text-muted">${file.name}</small>
                        </div>
                    </div>
                `;
                previewFotos.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    });
    
    // Eliminar fotos existentes
    document.querySelectorAll('.btn-eliminar-foto').forEach(btn => {
        btn.addEventListener('click', async function() {
            const fotoId = this.dataset.fotoId;
            
            const result = await Swal.fire({
                title: '¿Eliminar foto?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#d33'
            });
            
            if (result.isConfirmed) {
                fetch(`{% url 'complejos:eliminar_foto' complejo.slug 0 %}`.replace('/0/', `/${fotoId}/`), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`[data-foto-id="${fotoId}"]`).remove();
                        Swal.fire({
                            icon: 'success',
                            title: 'Eliminada',
                            text: 'La foto ha sido eliminada',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error || 'No se pudo eliminar la foto'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo eliminar la foto'
                    });
                });
            }
        });
    });
});
</script>
{% endblock %}
