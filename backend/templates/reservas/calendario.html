{% extends 'base.html' %}

{% block title %}Reservar {{ cancha.nombre }} - DeRevés{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ cancha.nombre }}</h5>
                            <p class="text-muted mb-0">{{ cancha.complejo.nombre }}</p>
                        </div>
                        <span class="badge bg-primary fs-5">${{ cancha.precio_hora }}/hora</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Navegación de fechas -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <a href="?fecha={{ fecha_anterior.isoformat }}" class="btn btn-outline-secondary">
                            <span class="material-symbols-rounded">chevron_left</span>
                            Anterior
                        </a>
                        <h4 class="mb-0">{{ fecha|date:"d/m/Y" }}</h4>
                        <a href="?fecha={{ fecha_siguiente.isoformat }}" class="btn btn-outline-secondary">
                            Siguiente
                            <span class="material-symbols-rounded">chevron_right</span>
                        </a>
                    </div>
                    
                    <!-- Grid de horarios -->
                    <div class="row g-2">
                        {% for horario in horarios %}
                        <div class="col-md-3 col-6">
                            {% if horario.ocupado %}
                                <button class="btn btn-outline-danger w-100 disabled" disabled>
                                    <span class="material-symbols-rounded">cancel</span>
                                    {{ horario.hora }}
                                    <small class="d-block">Ocupado</small>
                                </button>
                            {% else %}
                                <button class="btn btn-outline-success w-100 horario-disponible" 
                                        data-hora="{{ horario.hora }}" 
                                        data-hora-fin="{{ horario.hora_fin }}"
                                        data-precio="{{ horario.precio }}"
                                        onclick="seleccionarHorario('{{ horario.hora }}', '{{ horario.hora_fin }}', {{ horario.precio }})">
                                    <span class="material-symbols-rounded">check_circle</span>
                                    {{ horario.hora }} - {{ horario.hora_fin }}
                                    <small class="d-block">${{ horario.precio }}</small>
                                </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if not horarios %}
                    <div class="text-center text-muted py-5">
                        <span class="material-symbols-rounded" style="font-size: 64px;">event_busy</span>
                        <p class="mt-3">No hay horarios disponibles para esta fecha</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Resumen de Reserva -->
            <div class="card sticky-top" style="top: 80px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Resumen de Reserva</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'reservas:crear_reserva' cancha.id %}" id="formReserva">
                        {% csrf_token %}
                        <input type="hidden" name="fecha" value="{{ fecha.isoformat }}">
                        <input type="hidden" name="hora" id="horaSeleccionada">
                        
                        <div class="mb-3">
                            <label class="text-muted small">Cancha</label>
                            <p class="mb-0"><strong>{{ cancha.nombre }}</strong></p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-muted small">Fecha</label>
                            <p class="mb-0"><strong>{{ fecha|date:"d/m/Y" }}</strong></p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-muted small">Horario</label>
                            <p class="mb-0" id="horarioTexto">
                                <em class="text-muted">Selecciona un horario</em>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-muted small">Duración</label>
                            <p class="mb-0"><strong>{{ cancha.duracion_turno_minutos }} minutos</strong></p>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <label class="text-muted small">Total</label>
                            <h3 class="mb-0 text-success" id="precioTotal">$0</h3>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg" id="btnReservar" disabled>
                                <span class="material-symbols-rounded">event_available</span>
                                Reservar
                            </button>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <span class="material-symbols-rounded" style="font-size: 16px;">info</span>
                                El pago se realizará en el complejo
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function seleccionarHorario(hora, horaFin, precio) {
    // Remover selección previa
    document.querySelectorAll('.horario-disponible').forEach(btn => {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
    });
    
    // Marcar como seleccionado
    event.target.closest('.horario-disponible').classList.remove('btn-outline-success');
    event.target.closest('.horario-disponible').classList.add('btn-success');
    
    // Actualizar resumen
    document.getElementById('horaSeleccionada').value = hora;
    document.getElementById('horarioTexto').innerHTML = '<strong>' + hora + ' - ' + horaFin + '</strong>';
    document.getElementById('precioTotal').textContent = '$' + precio;
    document.getElementById('btnReservar').disabled = false;
}
</script>
{% endblock %}
