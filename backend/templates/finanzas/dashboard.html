    
    

<div class="container-fluid my-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>
                <span class="material-symbols-rounded">account_balance</span>
                Finanzas
            </h2>
            <p class="text-muted">{{ meses|slice:mes_actual|last }} {{ año_actual }}</p>
        </div>
        <div class="col-md-6 text-end">
            <!-- Selector de complejo -->
            <div class="d-inline-block me-2">
                <select class="form-select" id="selectorComplejo">
                    {% for complejo in complejos %}
                    <option value="{{ complejo.id }}" {% if complejo == complejo_seleccionado %}selected{% endif %}>
                        {{ complejo.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Botón nueva transacción -->
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaTransaccion">
                <span class="material-symbols-rounded">add</span>
                Nueva Transacción
            </button>
        </div>
    </div>
    
    <!-- Tarjetas de Resumen -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="stat-card ingreso">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase opacity-75">Ingresos</h6>
                        <h2 class="mb-0">${{ resumen.total_ingresos|floatformat:2 }}</h2>
                        <small>{{ resumen.cantidad_reservas }} reservas</small>
                    </div>
                    <span class="material-symbols-rounded icon">trending_up</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="stat-card gasto">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase opacity-75">Gastos</h6>
                        <h2 class="mb-0">${{ resumen.total_gastos|floatformat:2 }}</h2>
                        <small>{{ resumen.cantidad_transacciones }} transacciones</small>
                    </div>
                    <span class="material-symbols-rounded icon">trending_down</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="stat-card balance">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase opacity-75">Balance</h6>
                        <h2 class="mb-0">${{ resumen.balance|floatformat:2 }}</h2>
                        <small>{% if resumen.balance > 0 %}Ganancia{% elif resumen.balance < 0 %}Pérdida{% else %}Equilibrio{% endif %}</small>
                    </div>
                    <span class="material-symbols-rounded icon">account_balance_wallet</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos y Detalles -->
    <div class="row g-4">
        <!-- Gráfico de Ingresos vs Gastos -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ingresos vs Gastos (Últimos 6 meses)</h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoFinanzas" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Top Categorías de Gasto -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Gastos del Mes</h5>
                </div>
                <div class="card-body">
                    {% if gastos_por_categoria %}
                    <ul class="list-unstyled">
                        {% for gasto in gastos_por_categoria %}
                        <li class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>{{ gasto.categoria }}</span>
                                <strong>${{ gasto.total|floatformat:2 }}</strong>
                            </div>
                            <small class="text-muted">{{ gasto.cantidad }} transacciones</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center my-4">No hay gastos registrados este mes</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reservas Fijas consideradas pagadas automáticamente -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Reservas Fijas Pagadas Automáticamente (por horario cumplido)</h5>
                </div>
                <div class="card-body">
                    {% if reservas_fijas_extra_pagadas and reservas_fijas_extra_pagadas|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Cliente</th>
                                    <th>Precio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rf in reservas_fijas_extra_pagadas %}
                                <tr>
                                    <td>{{ rf.fecha|date:"d/m/Y" }}</td>
                                    <td>{{ rf.hora_inicio|time:"H:i" }} - {{ rf.hora_fin|time:"H:i" }}</td>
                                    <td>{{ rf.nombre }}</td>
                                    <td>${{ rf.precio|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted my-4">No hay reservas fijas consideradas pagadas automáticamente este mes.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    
    
    <!-- Últimas Transacciones -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Últimas Transacciones</h5>
                    <a href="{% url 'finanzas:reporte' %}" class="btn btn-sm btn-outline-primary">
                        Ver Reporte Completo
                    </a>
                </div>
                <div class="card-body">
                    {% if transacciones_mes %}
                    <div class="row g-3">
                        {% for transaccion in transacciones_mes %}
                        <div class="col-md-6">
                            <div class="transaction-item {{ transaccion.tipo|lower }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ transaccion.get_categoria_display }}</h6>
                                        <small class="text-muted">{{ transaccion.descripcion|truncatewords:10 }}</small>
                                        <div class="mt-1">
                                            <small class="text-muted">{{ transaccion.fecha|date:"d/m/Y" }}</small>
                                            {% if transaccion.reserva %}
                                                <span class="badge {% if transaccion.reserva.pagado %}bg-success{% else %}bg-warning text-dark{% endif %} ms-2">
                                                    {% if transaccion.reserva.pagado %}Pagado{% else %}Pendiente{% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <strong class="{% if transaccion.tipo == 'INGRESO' %}text-success{% else %}text-danger{% endif %}">
                                            {% if transaccion.tipo == 'INGRESO' %}+{% else %}-{% endif %}${{ transaccion.monto|floatformat:2 }}
                                        </strong>
                                        <div>
                                            <button class="btn btn-sm btn-link text-danger p-0 mt-1" onclick="eliminarTransaccion({{ transaccion.id }})">
                                                <span class="material-symbols-rounded" style="font-size: 18px;">delete</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted my-4">No hay transacciones registradas este mes</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Transacción -->
<div class="modal fade" id="modalNuevaTransaccion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Transacción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevaTransaccion" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="complejo_id" value="{{ complejo_seleccionado.id }}">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tipo *</label>
                        <select class="form-select" name="tipo" id="tipoTransaccion" required>
                            <option value="">Selecciona...</option>
                            <option value="INGRESO">Ingreso</option>
                            <option value="GASTO">Gasto</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categoría *</label>
                        <select class="form-select" name="categoria" id="categoriaTransaccion" required>
                            <option value="">Primero selecciona el tipo</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Monto *</label>
                        <input type="number" step="0.01" class="form-control" name="monto" required placeholder="0.00">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripción *</label>
                        <textarea class="form-control" name="descripcion" rows="3" required placeholder="Detalla la transacción..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Fecha *</label>
                        <input type="date" class="form-control" name="fecha" value="{{ resumen.año }}-{{ resumen.mes|stringformat:'02d' }}-01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Comprobante (opcional)</label>
                        <input type="file" class="form-control" name="comprobante" accept="image/*,application/pdf">
                        <small class="text-muted">Foto o PDF del ticket/factura</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Selector de complejo
    document.getElementById('selectorComplejo').addEventListener('change', function() {
        window.location.href = '?complejo=' + this.value;
    });
    
    // Categorías dinámicas
    const categoriasIngreso = [
        ['RESERVA', 'Reserva de Cancha'],
        ['RESERVA_FIJA', 'Reserva Fija'],
        ['SEÑA', 'Seña/Adelanto'],
        ['OTRO', 'Otro Ingreso']
    ];
    
    const categoriasGasto = [
        ['MANTENIMIENTO', 'Mantenimiento'],
        ['SERVICIOS', 'Servicios (Luz, Agua, Gas)'],
        ['SUELDOS', 'Sueldos'],
        ['EQUIPAMIENTO', 'Equipamiento'],
        ['LIMPIEZA', 'Limpieza'],
        ['IMPUESTOS', 'Impuestos'],
        ['PUBLICIDAD', 'Publicidad'],
        ['OTRO', 'Otro Gasto']
    ];
    
    document.getElementById('tipoTransaccion').addEventListener('change', function() {
        const categoriaSelect = document.getElementById('categoriaTransaccion');
        categoriaSelect.innerHTML = '<option value="">Selecciona una categoría</option>';
        
        const categorias = this.value === 'INGRESO' ? categoriasIngreso : categoriasGasto;
        
        categorias.forEach(([value, label]) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            categoriaSelect.appendChild(option);
        });
    });
    
    // Formulario nueva transacción
    document.getElementById('formNuevaTransaccion').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('{% url "finanzas:registrar_transaccion" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: data.mensaje,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'No se pudo registrar la transacción'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al registrar la transacción'
            });
        }
    });
    
    // Gráfico
    const ctx = document.getElementById('graficoFinanzas').getContext('2d');
    const datosGrafico = {{ datos_grafico|safe }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datosGrafico.map(d => d.mes),
            datasets: [{
                label: 'Ingresos',
                data: datosGrafico.map(d => d.ingresos),
                backgroundColor: 'rgba(56, 239, 125, 0.7)',
                borderColor: 'rgba(56, 239, 125, 1)',
                borderWidth: 1
            }, {
                label: 'Gastos',
                data: datosGrafico.map(d => d.gastos),
                backgroundColor: 'rgba(244, 92, 67, 0.7)',
                borderColor: 'rgba(244, 92, 67, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
});

// Eliminar transacción
async function eliminarTransaccion(id) {
    const result = await Swal.fire({
        title: '¿Eliminar transacción?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
    });
    
    if (result.isConfirmed) {
        try {
            const response = await fetch(`/finanzas/transaccion/${id}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Eliminada',
                    text: data.mensaje,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'No se pudo eliminar'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al eliminar la transacción'
            });
        }
    }
}
</script>
{% endblock %}
